'use strict';

let path = require('path');
module.exports = function () {
    return {
        process: function (next, input, output, args, fileContent, filePath) {
            try {
                let depFilePath = path.join(args.config.rootDir, filePath.replace(/([^.]+)\.js$/, '$1.deps.json')),
                    depFileContent = require(depFilePath);

                if (depFileContent) {
                    let services = depFileContent.services || [],
                        rawServices = services.filter(item => /^[A-Za-z0-9]/.test(item)),
                        quotedServices = rawServices.map(item => `'${item}'`);
                    fileContent = `beat.serveFunction([${quotedServices.join()}], (${rawServices.join()}) => { ${fileContent} });\n`;
                }
            } catch (error) {};
            output.set(filePath, fileContent);
            next();
        }
    };
};
