'use strict';

let path = require('path');
module.exports = function (prefixTemplate, postfixTemplate) {
    return {
        process: function (next, input, output, config, fileContent, filePath) {
            try {
                let depFilePath = path.join(config.rootDir, filePath.replace(/([^.]+)\.js$/, '$1.deps.json')),
                    depFileContent = require(depFilePath);

                if (depFileContent) {
                    let services = depFileContent.services || [],
                        rawServices = services.filter(item => /^[A-Za-z0-9]/.test(item)),
                        quotedServices = rawServices.map(item => `'${item}'`),
                        argumentsRegExp = /\$ARGUMENTS/g,
                        servicesRegExp = /\$SERVICES/g;

                    rawServices = rawServices.join();
                    quotedServices = quotedServices.join();

                    let prefix = prefixTemplate
                            .replace(argumentsRegExp, rawServices)
                            .replace(servicesRegExp, quotedServices),
                        postfix = postfixTemplate
                            .replace(argumentsRegExp, rawServices)
                            .replace(servicesRegExp, quotedServices);

                    fileContent = prefix + fileContent + postfix;
                }
            } catch (error) {};
            output.set(filePath, fileContent);
            next();
        }
    };
};
