'use strict';

let path = require('path');
module.exports = function (app) {
    let extraArguments = [].slice.call(arguments);
    return {
        process: function (next, input, output, args, fileContent, relFilePath) {
            try {
                let filePath = path.join(args.config.rootDir, relFilePath);
                delete require.cache[require.resolve(filePath)];
                let handler = require(filePath).apply(undefined, extraArguments);
                if (typeof handler === 'function') {
                    app.setHandler(relFilePath, handler);
                    next();
                } else {
                    next(`Module of handler returns not a function! (path: ${relFilePath})`);
                }
            } catch (error) {
                next(error);
            }
        }
    };
};
