'use strict';

let path = require('path'),
    utils = require('gobem/utils');

module.exports = function () {
    return {
        process: function (next, input, output, args, fileContent, filePath) {
            let moduleInfo = utils.getModuleInfo(filePath);
            if (moduleInfo.langName) return next();
            moduleInfo.modName = moduleInfo.modVal = null;
            let modulePath = utils.generateModulePath(moduleInfo);
            if (output.get(modulePath + '.html')) return next();

            let tagName = moduleInfo.blockName + (moduleInfo.elemName ? '__' + moduleInfo.elemName : ''),
                content = '';
            content += `<template>`;
            content += input.get(modulePath + '.html') ?
                `${input.get(modulePath + '.html')}` :
                `<content />`;
            content += `</template>`;

            if (input.get(modulePath + '.js')) {
                output.set(modulePath + '.js', input.get(modulePath + '.js'));
            } else {
                output.set(modulePath + '.js', `beat.registerElement('${tagName}');`);
            }
            output.set(modulePath + '.html', content);

            next();
        }
    };
};
